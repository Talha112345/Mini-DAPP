<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My dApp Assignment</title>
  <link rel="stylesheet" href="style.css">

  <!-- ✅ Updated Ethers.js Import -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>

<body>
  <header>
    <h1>My dApp Assignment</h1>
    <p>A simple frontend for my Solidity Smart Contract.</p>
    <button id="connectButton">Connect Wallet</button>
    <!-- Added a link -->
    <p>Check contract on Sepolia Etherscan: 
      <a href="https://sepolia.etherscan.io/address/0xdd7d218977c0dd391B3B4076A0C6221Cca76C1cF" target="_blank">View Contract</a>
    </p>
  </header>

  <main>
    <!-- Section for Reading Data -->
    <section class="card">
      <h2>Read from Contract</h2>
      
      <!-- Added a list of reading options -->
      <ul>
        <li>Click "Get Message" to read the current message</li>
        <li>Click "Get Value" to read the current value</li>
        <li>Click "Get Owner" to read the contract owner</li>
      </ul>

      <button id="readButton">1. Get Message</button>
      <p>Current Message: <strong id="messageDisplay" class="placeholder">(Click button to fetch)</strong></p>

      <button id="readValButton">2. Get Value</button>
      <p>Current Value: <strong id="valueDisplay" class="placeholder">(Click button to fetch)</strong></p>

      <button id="readOwnerButton">3. Get Owner</button>
      <p>Contract Owner: <strong id="ownerDisplay" class="placeholder">(Click button to fetch)</strong></p>
    </section>

    <!-- Section for Writing Data -->
    <section class="card">
      <h2>Write to Contract</h2>
      
      <div>
        <label for="messageInput">Set New Message:</label>
        <input type="text" id="messageInput" placeholder="Enter new message...">
        <button id="writeButton">Set Message</button>
      </div>
      
      <div>
        <p>Increment the stored value:</p>
        <button id="incrementButton">Increment Value</button>
      </div>

      <!-- Added an image -->
      <img src="screenshots/transaction.png" alt="Transaction Demo" width="200">

      <p>Transaction Status: <strong id="txStatus">Idle</strong></p>
    </section>
  </main>

  <script>
    // ✅ Contract Info
    const contractAddress = "0xdd7d218977c0dd391B3B4076A0C6221Cca76C1cF";
    const contractABI = [/* Paste your full ABI here */];

    // ✅ Global Variables
    let provider;
    let signer;
    let contract;

    // ✅ HTML Elements
    const connectButton = document.getElementById('connectButton');
    const readButton = document.getElementById('readButton');
    const readValButton = document.getElementById('readValButton');
    const readOwnerButton = document.getElementById('readOwnerButton');
    const writeButton = document.getElementById('writeButton');
    const incrementButton = document.getElementById('incrementButton');
    const messageDisplay = document.getElementById('messageDisplay');
    const valueDisplay = document.getElementById('valueDisplay');
    const ownerDisplay = document.getElementById('ownerDisplay');
    const messageInput = document.getElementById('messageInput');
    const txStatus = document.getElementById('txStatus');

    // ✅ Connect Wallet with improved error handling
    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask not found! Please install it first.");
        return;
      }

      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);

        const address = await signer.getAddress();
        connectButton.textContent = `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;
        connectButton.style.backgroundColor = '#28a745';
        txStatus.textContent = 'Wallet connected successfully.';
        console.log("Wallet connected!");
      } catch (error) {
        console.error("Connection error:", error);
        if (error.code === 4001) { // User rejected request
          txStatus.textContent = 'Connection canceled by user. Please try again.';
        } else {
          txStatus.textContent = 'Connection failed. Check console for details.';
        }
      }
    }

    // ✅ Read Functions
    async function getMessage() {
      if (!contract) return alert("Connect wallet first!");
      try {
        const message = await contract.getMessage();
        messageDisplay.textContent = message;
      } catch (err) {
        console.error(err);
        txStatus.textContent = "Error reading message.";
      }
    }

    async function getValue() {
      if (!contract) return alert("Connect wallet first!");
      try {
        const val = await contract.getValue();
        valueDisplay.textContent = val.toString();
      } catch (err) {
        console.error(err);
        txStatus.textContent = "Error reading value.";
      }
    }

    async function getOwner() {
      if (!contract) return alert("Connect wallet first!");
      try {
        const owner = await contract.getOwner();
        ownerDisplay.textContent = owner;
      } catch (err) {
        console.error(err);
        txStatus.textContent = "Error reading owner.";
      }
    }

    // ✅ Write Functions
    async function setMessage() {
      if (!contract) return alert("Connect wallet first!");
      const newMessage = messageInput.value;
      if (!newMessage) return alert("Enter a message first!");
      try {
        const tx = await contract.setMessage(newMessage);
        txStatus.textContent = "Transaction sent. Waiting for confirmation...";
        await tx.wait();
        txStatus.textContent = "Message updated successfully!";
        getMessage();
        messageInput.value = "";
      } catch (err) {
        console.error(err);
        txStatus.textContent = "Transaction failed.";
      }
    }

    async function incrementValue() {
      if (!contract) return alert("Connect wallet first!");
      try {
        const tx = await contract.incrementValue();
        txStatus.textContent = "Transaction sent. Waiting for confirmation...";
        await tx.wait();
        txStatus.textContent = "Value incremented!";
        getValue();
      } catch (err) {
        console.error(err);
        txStatus.textContent = "Transaction failed.";
      }
    }

    // ✅ Event Listeners
    connectButton.onclick = connectWallet;
    readButton.onclick = getMessage;
    readValButton.onclick = getValue;
    readOwnerButton.onclick = getOwner;
    writeButton.onclick = setMessage;
    incrementButton.onclick = incrementValue;
  </script>
</body>
</html>
