<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My dApp Assignment</title>
  <link rel="stylesheet" href="style.css">

  <!-- ✅ Updated Ethers.js Import (Correct CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>

<body>

  <header>
    <h1>My dApp Assignment</h1>
    <p>A simple frontend for my Solidity Smart Contract.</p>
    <button id="connectButton">Connect Wallet</button>
  </header>

  <main>
    <!-- Section for Reading Data -->
    <section class="card">
      <h2>Read from Contract</h2>
      <button id="readButton">1. Get Message</button>
      <p>Current Message: <strong id="messageDisplay" class="placeholder">(Click button to fetch)</strong></p>

      <button id="readValButton">2. Get Value</button>
      <p>Current Value: <strong id="valueDisplay" class="placeholder">(Click button to fetch)</strong></p>

      <button id="readOwnerButton">3. Get Owner</button>
      <p>Contract Owner: <strong id="ownerDisplay" class="placeholder">(Click button to fetch)</strong></p>
    </section>

    <!-- Section for Writing Data -->
    <section class="card">
      <h2>Write to Contract</h2>
      
      <div>
        <label for="messageInput">Set New Message:</label>
        <input type="text" id="messageInput" placeholder="Enter new message...">
        <button id="writeButton">Set Message</button>
      </div>
      
      <div>
        <p>Increment the stored value:</p>
        <button id="incrementButton">Increment Value</button>
      </div>

      <p>Transaction Status: <strong id="txStatus">Idle</strong></p>
    </section>
  </main>

  <script>
    // ✅ Contract Info
    const contractAddress = "0xdd7d218977c0dd391B3B4076A0C6221Cca76C1cF";
    const contractABI = [
      {
        "inputs": [],
        "name": "incrementValue",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "string",
            "name": "initMessage",
            "type": "string"
          }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "string",
            "name": "oldMessage",
            "type": "string"
          },
          {
            "indexed": false,
            "internalType": "string",
            "name": "newMessage",
            "type": "string"
          }
        ],
        "name": "MessageUpdated",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "string",
            "name": "newMessage",
            "type": "string"
          }
        ],
        "name": "setMessage",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "newValue",
            "type": "uint256"
          }
        ],
        "name": "ValueIncremented",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "getMessage",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getOwner",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getValue",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "message",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "value",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // ✅ Global Variables
    let provider;
    let signer;
    let contract;

    // ✅ HTML Elements
    const connectButton = document.getElementById('connectButton');
    const readButton = document.getElementById('readButton');
    const readValButton = document.getElementById('readValButton');
    const readOwnerButton = document.getElementById('readOwnerButton');
    const writeButton = document.getElementById('writeButton');
    const incrementButton = document.getElementById('incrementButton');
    const messageDisplay = document.getElementById('messageDisplay');
    const valueDisplay = document.getElementById('valueDisplay');
    const ownerDisplay = document.getElementById('ownerDisplay');
    const messageInput = document.getElementById('messageInput');
    const txStatus = document.getElementById('txStatus');

    // ✅ Connect Wallet
    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);

          const address = await signer.getAddress();
          connectButton.textContent = `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;
          connectButton.style.backgroundColor = '#28a745';
          txStatus.textContent = 'Wallet connected successfully.';
          console.log("Wallet connected!");
        } catch (error) {
          console.error("Connection error:", error);
          txStatus.textContent = 'Error: User denied access or connection failed.';
        }
      } else {
        alert("MetaMask not found! Please install it first.");
      }
    }

    // ✅ Read Functions
    async function getMessage() {
      try {
        const message = await contract.getMessage();
        messageDisplay.textContent = message;
        console.log("Message:", message);
      } catch (err) {
        console.error("Error reading message:", err);
      }
    }

    async function getValue() {
      try {
        const val = await contract.getValue();
        valueDisplay.textContent = val.toString();
        console.log("Value:", val.toString());
      } catch (err) {
        console.error("Error reading value:", err);
      }
    }

    async function getOwner() {
      try {
        const owner = await contract.getOwner();
        ownerDisplay.textContent = owner;
        console.log("Owner:", owner);
      } catch (err) {
        console.error("Error reading owner:", err);
      }
    }

    // ✅ Write Functions
    async function setMessage() {
      const newMessage = messageInput.value;
      if (!newMessage) {
        alert("Please enter a message first!");
        return;
      }
      try {
        const tx = await contract.setMessage(newMessage);
        txStatus.textContent = "Transaction sent. Waiting for confirmation...";
        await tx.wait();
        txStatus.textContent = "Message updated successfully!";
        getMessage();
        messageInput.value = "";
      } catch (err) {
        console.error("Transaction failed:", err);
        txStatus.textContent = "Error: Transaction failed.";
      }
    }

    async function incrementValue() {
      try {
        const tx = await contract.incrementValue();
        txStatus.textContent = "Transaction sent. Waiting for confirmation...";
        await tx.wait();
        txStatus.textContent = "Value incremented!";
        getValue();
      } catch (err) {
        console.error("Increment failed:", err);
        txStatus.textContent = "Error: Transaction failed.";
      }
    }

    // ✅ Event Listeners
    connectButton.onclick = connectWallet;
    readButton.onclick = getMessage;
    readValButton.onclick = getValue;
    readOwnerButton.onclick = getOwner;
    writeButton.onclick = setMessage;
    incrementButton.onclick = incrementValue;
  </script>
</body>
</html>
