<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My dApp Assignment</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Ethers.js Library -->
    <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="application/javascript"></script>
</head>

<body>
    <header>
        <h1>My dApp Assignment</h1>
        <p>A simple frontend for my Solidity Smart Contract.</p>
        <button id="connectButton">Connect Wallet</button>
    </header>

    <main>
        <!-- Section for Reading Data -->
        <section class="card">
            <h2>Read from Contract</h2>
            <p>Get the current data stored in the contract.</p>
            
            <button id="readButton">1. Get Message</button>
            <p>Current Message: <strong id="messageDisplay" class="placeholder">(Click button to fetch)</strong></p>
            
            <button id="readValButton">2. Get Value</button>
            <p>Current Value: <strong id="valueDisplay" class="placeholder">(Click button to fetch)</strong></p>

            <button id="readOwnerButton">3. Get Owner</button>
            <p>Contract Owner: <strong id="ownerDisplay" class="placeholder">(Click button to fetch)</strong></p>
        </section>

        <!-- Section for Writing Data -->
        <section class="card">
            <h2>Write to Contract</h2>
            
            <div>
                <label for="messageInput">Set New Message:</label>
                <input type="text" id="messageInput" placeholder="Enter new message...">
                <button id="writeButton">Set Message</button>
            </div>
            
            <div>
                <p>Increment the stored value:</p>
                <button id="incrementButton">Increment Value</button>
            </div>

            <p>Transaction Status: <strong id="txStatus">Idle</strong></p>
        </section>
    </main>

    <script>
        // --- CONTRACT DETAILS ---
        const contractAddress = "0xdd7d218977c0dd391B3B4076A0C6221Cca76C1cF";
        const contractABI = [
            {
                "inputs": [],
                "name": "incrementValue",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "string", "name": "initMessage", "type": "string"}],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": false, "internalType": "string", "name": "oldMessage", "type": "string"},
                    {"indexed": false, "internalType": "string", "name": "newMessage", "type": "string"}
                ],
                "name": "MessageUpdated",
                "type": "event"
            },
            {
                "inputs": [{"internalType": "string", "name": "newMessage", "type": "string"}],
                "name": "setMessage",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": false, "internalType": "uint256", "name": "newValue", "type": "uint256"}],
                "name": "ValueIncremented",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "getMessage",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getOwner",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getValue",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "message",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "value",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // --- GLOBAL VARIABLES ---
        let provider;
        let signer;
        let contract;

        // --- GETTING ELEMENTS ---
        const connectButton = document.getElementById('connectButton');
        const readButton = document.getElementById('readButton');
        const messageDisplay = document.getElementById('messageDisplay');
        const readValButton = document.getElementById('readValButton');
        const valueDisplay = document.getElementById('valueDisplay');
        const readOwnerButton = document.getElementById('readOwnerButton'); 
        const ownerDisplay = document.getElementById('ownerDisplay'); 
        const writeButton = document.getElementById('writeButton');
        const messageInput = document.getElementById('messageInput');
        const incrementButton = document.getElementById('incrementButton');
        const txStatus = document.getElementById('txStatus');

        // --- FUNCTIONS ---

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);

                    const userAddress = accounts[0];
                    connectButton.textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                    connectButton.style.backgroundColor = '#28a745';
                    txStatus.textContent = "Wallet connected! Click 'Get' buttons to fetch data.";
                    txStatus.className = "status-success";
                    console.log("Wallet connected successfully:", userAddress);

                } catch (error) {
                    console.error("Error connecting wallet:", error);
                    if (error.code === 4001) {
                        txStatus.textContent = "Error: You denied connection in MetaMask.";
                    } else {
                        txStatus.textContent = `Error: ${error.message}`;
                    }
                    txStatus.className = "status-error";
                }
            } else {
                console.log('MetaMask not installed!');
                connectButton.textContent = 'Please install MetaMask!';
                connectButton.style.backgroundColor = '#dc3545';
            }
        }

        async function getMessage() {
            if (!contract) return showError("Please connect your wallet first.");
            try {
                txStatus.textContent = "Fetching message...";
                const message = await contract.getMessage();
                messageDisplay.textContent = message;
                txStatus.textContent = "Idle";
            } catch (error) {
                showError("Error fetching message.");
                console.error(error);
            }
        }

        async function getValue() {
            if (!contract) return showError("Please connect your wallet first.");
            try {
                txStatus.textContent = "Fetching value...";
                const val = await contract.getValue();
                valueDisplay.textContent = val.toString();
                txStatus.textContent = "Idle";
            } catch (error) {
                showError("Error fetching value.");
                console.error(error);
            }
        }

        async function getOwner() {
            if (!contract) return showError("Please connect your wallet first.");
            try {
                txStatus.textContent = "Fetching owner...";
                const owner = await contract.getOwner();
                ownerDisplay.textContent = owner;
                txStatus.textContent = "Idle";
            } catch (error) {
                showError("Error fetching owner.");
                console.error(error);
            }
        }

        async function setMessage() {
            if (!signer) return showError("Please connect your wallet first.");
            const newMessage = messageInput.value.trim();
            if (!newMessage) return showError("Please enter a message.");

            try {
                txStatus.textContent = "Sending transaction (check MetaMask)...";
                const tx = await contract.setMessage(newMessage);
                txStatus.textContent = `Transaction pending... (Hash: ${tx.hash.substring(0, 8)}...)`;
                await tx.wait();
                txStatus.textContent = "Transaction successful!";
                txStatus.className = "status-success";
                messageInput.value = "";
                getMessage();
            } catch (error) {
                showError("Transaction failed.");
                console.error(error);
            }
        }

        async function incrementValue() {
            if (!signer) return showError("Please connect your wallet first.");
            try {
                txStatus.textContent = "Sending transaction (check MetaMask)...";
                const tx = await contract.incrementValue();
                txStatus.textContent = `Transaction pending... (Hash: ${tx.hash.substring(0, 8)}...)`;
                await tx.wait();
                txStatus.textContent = "Transaction successful!";
                txStatus.className = "status-success";
                getValue();
            } catch (error) {
                showError("Transaction failed.");
                console.error(error);
            }
        }

        // --- HELPER ---
        function showError(msg) {
            txStatus.textContent = msg;
            txStatus.className = "status-error";
        }

        // --- EVENT LISTENERS ---
        connectButton.onclick = connectWallet;
        readButton.onclick = getMessage;
        readValButton.onclick = getValue;
        readOwnerButton.onclick = getOwner;
        writeButton.onclick = setMessage;
        incrementButton.onclick = incrementValue;

        // --- WALLET EVENT HANDLERS ---
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    connectButton.textContent = `Connected: ${accounts[0].substring(0, 6)}...${accounts[0].substring(accounts[0].length - 4)}`;
                } else {
                    connectButton.textContent = 'Connect Wallet';
                    txStatus.textContent = 'Disconnected.';
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
